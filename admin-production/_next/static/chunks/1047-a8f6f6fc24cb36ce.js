"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1047],{666:function(e,t,s){var r=s(5893),a=s(7294),n=s(7029),c=s(1352),i=s(9886),o=s(5041),l=s(776),u=s(8142);t.Z=e=>{let{onScan:t,onError:s,onClose:h,isActive:d}=e,g=(0,a.useRef)(null),y=(0,a.useRef)(null),[m,w]=(0,a.useState)(null),[p,f]=(0,a.useState)(!1),[x,b]=(0,a.useState)([]),[v,j]=(0,a.useState)(""),[N,S]=(0,a.useState)(!1),[k,C]=(0,a.useState)("prompt");(0,a.useEffect)(()=>{let e=!0;return(async()=>{if(d&&g.current)try{let t=await n.w.checkCameraPermission();if(C(t),"denied"===t){s("カメラの使用が拒否されています。ブラウザの設定で許可してください。");return}let r=await n.w.getCameras();e&&(b(r),r.length>0&&j(r[0].id));let a=new n.w;await a.initialize(g.current),e&&w(a)}catch(t){e&&s("スキャナーの初期化に失敗しました: ".concat(t instanceof Error?t.message:"Unknown error"))}})(),()=>{e=!1,m&&m.destroy()}},[d]),(0,a.useEffect)(()=>{{let e=e=>{t(e.detail)};return window.addEventListener("qr-scan-result",e),()=>{window.removeEventListener("qr-scan-result",e)}}},[t]);let E=async()=>{if(m)try{await m.startScanning(),f(!0)}catch(e){s("スキャン開始に失敗しました: ".concat(e instanceof Error?e.message:"Unknown error"))}},R=async()=>{if(m)try{let e=await m.toggleFlashlight();S(e)}catch(e){s("フラッシュライトの制御に失敗しました: ".concat(e instanceof Error?e.message:"Unknown error"))}},F=async e=>{if(m)try{await m.setCamera(e),j(e)}catch(e){s("カメラの切り替えに失敗しました: ".concat(e instanceof Error?e.message:"Unknown error"))}},P=async e=>{var r;let a=null===(r=e.target.files)||void 0===r?void 0:r[0];if(a){try{let e={data:await n.w.scanFile(a),timestamp:new Date,format:"FILE_UPLOAD"};t(e)}catch(e){s("ファイルからのQRコード読み取りに失敗しました: ".concat(e instanceof Error?e.message:"Unknown error"))}y.current&&(y.current.value="")}};return d?(0,r.jsx)("div",{className:"fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50",children:(0,r.jsxs)("div",{className:"bg-white rounded-3xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-hidden",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-gray-200",children:[(0,r.jsx)("h3",{className:"text-xl font-bold text-gray-800",children:"QRコードスキャン"}),(0,r.jsx)("button",{onClick:h,className:"p-2 hover:bg-gray-100 rounded-full transition-colors",children:(0,r.jsx)(c.Z,{className:"w-5 h-5 text-gray-600"})})]}),(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("video",{ref:g,className:"w-full h-64 object-cover bg-black",autoPlay:!0,muted:!0,playsInline:!0}),(0,r.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,r.jsx)("div",{className:"w-48 h-48 border-4 border-white rounded-2xl opacity-50"})}),"denied"===k&&(0,r.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-black/50",children:(0,r.jsxs)("div",{className:"text-center text-white p-4",children:[(0,r.jsx)(i.Z,{className:"w-12 h-12 mx-auto mb-2"}),(0,r.jsx)("p",{className:"text-sm",children:"カメラの使用が拒否されています"})]})})]}),(0,r.jsxs)("div",{className:"p-4 space-y-4",children:[(0,r.jsx)("div",{className:"flex justify-center",children:p?(0,r.jsxs)("button",{onClick:()=>{m&&(m.stopScanning(),f(!1))},className:"flex items-center space-x-2 px-6 py-3 bg-red-500 text-white rounded-2xl font-semibold hover:bg-red-600 transition-colors",children:[(0,r.jsx)(i.Z,{className:"w-5 h-5"}),(0,r.jsx)("span",{children:"停止"})]}):(0,r.jsxs)("button",{onClick:E,disabled:!m,className:"flex items-center space-x-2 px-6 py-3 bg-blue-500 text-white rounded-2xl font-semibold hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:[(0,r.jsx)(o.Z,{className:"w-5 h-5"}),(0,r.jsx)("span",{children:"スキャン開始"})]})}),(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[x.length>1&&(0,r.jsx)("select",{value:v,onChange:e=>F(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg text-sm",children:x.map(e=>(0,r.jsx)("option",{value:e.id,children:e.label||"Camera ".concat(e.id)},e.id))}),(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)("button",{onClick:R,className:"p-2 rounded-lg transition-colors ".concat(N?"bg-yellow-100 text-yellow-600":"bg-gray-100 text-gray-600 hover:bg-gray-200"),children:(0,r.jsx)(l.Z,{className:"w-5 h-5"})}),(0,r.jsx)("button",{onClick:()=>{var e;return null===(e=y.current)||void 0===e?void 0:e.click()},className:"p-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition-colors",children:(0,r.jsx)(u.Z,{className:"w-5 h-5"})})]})]}),(0,r.jsx)("input",{ref:y,type:"file",accept:"image/*",onChange:P,className:"hidden"}),(0,r.jsxs)("div",{className:"text-center text-sm text-gray-600 space-y-1",children:[(0,r.jsx)("p",{children:"QRコードをカメラの枠内に合わせてください"}),(0,r.jsx)("p",{children:"または画像ファイルをアップロードしてください"})]})]})]})}):null}},8126:function(e,t,s){s.d(t,{E:function(){return c}});var r=s(7066),a=s(255);class n{async get(e,t){return(await this.client.get(e,t)).data}async post(e,t,s){return(await this.client.post(e,t,s)).data}async put(e,t,s){return(await this.client.put(e,t,s)).data}async delete(e,t){return(await this.client.delete(e,t)).data}async grantPoints(e,t,s){return this.post("/api/points/grant/",{uid:e,points:t,reason:s})}async getPointsHistory(e){return this.get("/api/points/history/",{params:e})}async chargePoints(e,t){return this.post("/api/charge/",{amount:e,payment_method:t})}async getChargeHistory(){return this.get("/api/charge/history/")}async getDashboardStats(){return this.get("/api/dashboard/stats/")}async lookupUserByNFC(e){return this.get("/api/nfc/lookup/".concat(e,"/"))}async getGiftCategories(){return this.get("/api/gifts/categories/")}async getGifts(e){return this.get("/api/gifts/",{params:e})}async getGiftDetail(e){return this.get("/api/gifts/".concat(e,"/"))}async exchangeGift(e,t){return this.post("/api/gifts/exchange/",{gift_id:e,...t})}async getGiftExchangeHistory(){return this.get("/api/gifts/exchange/history/")}async getGiftExchangeDetail(e){return this.get("/api/gifts/exchange/".concat(e,"/"))}async request(e,t,s){return(await this.client.request({method:e,url:t,data:s})).data}async requestPasswordReset(e){try{let t=await this.request("POST","/auth/password-reset/",{email:e});return{success:!0,data:t}}catch(e){return{success:!1,error:"パスワードリセット要求に失敗しました"}}}async confirmPasswordReset(e,t){try{let s=await this.request("POST","/auth/password-reset-confirm/",{token:e,password:t});return{success:!0,data:s}}catch(e){return{success:!1,error:"パスワードリセットに失敗しました"}}}async setupTwoFactor(){try{let e=await this.request("POST","/auth/two-factor/setup/");return{success:!0,qr_code_url:e.qr_code_url,backup_codes:e.backup_codes,secret:e.secret}}catch(e){return{success:!1,error:"2FA設定に失敗しました"}}}async verifyTwoFactor(e){try{let t=await this.request("POST","/auth/two-factor/verify/",{token:e});return{success:!0,data:t}}catch(e){return{success:!1,error:"2FA認証に失敗しました"}}}async getTwoFactorStatus(){try{let e=await this.request("GET","/auth/two-factor/status/");return{success:!0,data:e}}catch(e){return{success:!1,error:"2FA状態の取得に失敗しました"}}}async disableTwoFactor(){try{let e=await this.request("POST","/auth/two-factor/disable/");return{success:!0,data:e}}catch(e){return{success:!1,error:"2FA無効化に失敗しました"}}}async generateBackupCodes(){try{let e=await this.request("POST","/auth/two-factor/backup-codes/");return{success:!0,backup_codes:e.backup_codes}}catch(e){return{success:!1,error:"バックアップコード生成に失敗しました"}}}constructor(){this.client=r.Z.create({baseURL:"https://extending-guys-chess-prescribed.trycloudflare.com",timeout:1e4}),this.client.interceptors.request.use(e=>{let t=a.ON.getTokens();return(null==t?void 0:t.access)&&(e.headers.Authorization="Bearer ".concat(t.access)),e},e=>Promise.reject(e)),this.client.interceptors.response.use(e=>e,async e=>{var t;let s=e.config;if((null===(t=e.response)||void 0===t?void 0:t.status)===401&&!s._retry){s._retry=!0;try{await a.ON.refreshTokens();let e=a.ON.getTokens();if(null==e?void 0:e.access)return s.headers.Authorization="Bearer ".concat(e.access),this.client(s)}catch(e){return a.ON.logout(),Promise.reject(e)}}return Promise.reject(e)})}}let c=new n},7029:function(e,t,s){s.d(t,{F:function(){return n},w:function(){return a}});var r=s(3006);class a{async initialize(e){if(!e)throw Error("Video element is required");this.videoElement=e;try{if(!await r.Z.hasCamera())throw Error("カメラが見つかりませんでした");this.scanner=new r.Z(e,e=>this.handleScanResult(e),{returnDetailedScanResult:!0,highlightScanRegion:!0,highlightCodeOutline:!0,overlay:this.createOverlay()}),console.log("QR Scanner initialized")}catch(e){throw console.error("Failed to initialize QR scanner:",e),e}}async startScanning(){if(!this.scanner)throw Error("Scanner not initialized");if(this.isScanning){console.log("Scanner is already running");return}try{await this.scanner.start(),this.isScanning=!0,console.log("QR scanning started")}catch(e){throw console.error("Failed to start QR scanning:",e),e}}stopScanning(){this.scanner&&this.isScanning&&(this.scanner.stop(),this.isScanning=!1,console.log("QR scanning stopped"))}destroy(){this.scanner&&(this.scanner.destroy(),this.scanner=null,this.isScanning=!1,console.log("QR scanner destroyed"))}static async getCameras(){try{return await r.Z.listCameras(!0)}catch(e){return console.error("Failed to get cameras:",e),[]}}async setCamera(e){if(!this.scanner)throw Error("Scanner not initialized");try{await this.scanner.setCamera(e),console.log("Camera changed:",e)}catch(e){throw console.error("Failed to change camera:",e),e}}async toggleFlashlight(){if(!this.scanner)throw Error("Scanner not initialized");try{return console.log("Flashlight control not yet implemented"),!1}catch(e){throw console.error("Failed to toggle flashlight:",e),e}}isCurrentlyScanning(){return this.isScanning}handleScanResult(e){let t={data:e.data,timestamp:new Date,format:e.cornerPoints?"QR_CODE":"UNKNOWN"},s=new CustomEvent("qr-scan-result",{detail:t});window.dispatchEvent(s),console.log("QR Code scanned:",t)}createOverlay(){let e=document.createElement("div");return e.className="qr-scanner-overlay",e.style.cssText="\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      pointer-events: none;\n      border: 2px solid rgba(0, 255, 0, 0.5);\n      box-sizing: border-box;\n    ",e}static async scanFile(e){try{return await r.Z.scanImage(e)}catch(e){throw console.error("Failed to scan file:",e),Error("QRコードを読み取れませんでした")}}static async scanFromUrl(e){try{return await r.Z.scanImage(e)}catch(e){throw console.error("Failed to scan from URL:",e),Error("QRコードを読み取れませんでした")}}static async checkCameraPermission(){try{return(await navigator.permissions.query({name:"camera"})).state}catch(e){return console.error("Failed to check camera permission:",e),"prompt"}}static async getVideoConstraints(){return{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}}constructor(){this.scanner=null,this.isScanning=!1,this.videoElement=null}}class n{static isUID(e){return/^[A-Z0-9_-]+$/.test(e)&&e.length>=4}static isURL(e){try{return new URL(e),!0}catch(e){return!1}}static isJSON(e){try{return JSON.parse(e),!0}catch(e){return!1}}static getDataType(e){return this.isUID(e)?"uid":this.isURL(e)?"url":this.isJSON(e)?"json":"text"}static extractUID(e){switch(this.getDataType(e)){case"uid":return e;case"url":try{let t=new URL(e);return t.searchParams.get("uid")||t.searchParams.get("id")}catch(e){return null}case"json":try{let t=JSON.parse(e);return t.uid||t.id||t.user_id||null}catch(e){return null}default:return null}}}}}]);